<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>登录</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="css/fcds_login.css">
</head>
<body>
	<div class="wrapper">
		<div class="logo"><img src="images/logo.png" alt=""></div>
<!-- 		<div class="system_name">
			<p>纬德富诚</p>
			<p>经纪商服务平台</p>
		</div> -->
		<div class="login_info">
			<!-- <div class="login_header">经纪商登录</div> -->
			<p class="tip" id="tip">&nbsp;</p>
			<div class="in_info_box">
				<p class="in_info">
					<span>经纪商账号：</span><input type="tel" name='brokerUserNo' id="brokerUserNo" placeholder="您的经纪商账号">
				</p>
			</div>
			<div class="in_info_box">
				<p class="in_info">
					<span>手机号码：</span><i></i>
				</p>
			</div>
			<div class="in_info_box">
				<p class="in_info pr">
					<span>动态密码：</span><input type="tel" name='DynamicPassword' id="DynamicPassword" placeholder="您的动态密码"><b id="verification_btn">获取动态密码</b>
				</p>
				
			</div>
			<a href="javascript:;" class="login_btn" id="login">登录</a>
		</div>
	</div>

	<script src="js/jquery-1.8.3.min.js"></script>
  <script src="js/jquery.cookie.js"></script>
	<script type="text/javascript">
		$(function(){
			//移动端兼容
			var autoScale = function() {
       				var ratio = 375/590,
       				winW = document.documentElement.clientWidth,
       				winH = document.documentElement.clientHeight,
       				ratio2 = winW/winH,
       				scale;

       				if (ratio < ratio2) {
       					scale = (winH/590).toString().substring(0, 6);
       				} else {
       					scale = (winW/375).toString().substring(0, 6);
       				}
       				var cssText = '-webkit-transform: scale('+ scale +'); -webkit-transform-origin: center center; opacity: 1;';
       				$('.wrapper').attr('style', cssText);
       			}
       			setTimeout(function(){
       				if(document.documentElement.clientWidth/document.documentElement.clientHeight != 375/590) {
       					autoScale();
       				}else{

       				}
       			}, 300);

       	

        // 获取手机号
        $("#brokerUserNo").keyup(function(){
          var length = $("#brokerUserNo").val().length;
          var value = $("#brokerUserNo").val();
          if(length == 4){
            
            var param = new Object();
            param.brokerUserNo=$("#brokerUserNo").val();
            var brokerUserNo = JSON.stringify(param);
            $.ajax({  
                type: "post",
                url: "/member-server-front/broker/getPhone",
                data:brokerUserNo,
                dataType: "json",
                success: function(data) {
                  $(".wrapper .login_info p.in_info i").html(data.data);
                  // $("#tip").html('<span class="tip_text">'+data.message+'</span>');

                  if(data.status > 0){
                    $("#verification_btn").css("display","none");
                  $("#tip").html('<span class="tip_text">'+data.message+'</span>');
                  }else if(data.status == 0){
                    $("#verification_btn").css("display","block");
                    // 验证码倒时计时
                    var wait=60;
                    function time(o) {
                      document.getElementById("verification_btn").onclick = null;
                          if (wait == 0) {
                              o.removeAttribute("disabled");           
                              o.innerHTML="获取验证码";
                              wait = 60;
                              document.getElementById("verification_btn").onclick=function(){time(this);}
                          } else {
                              o.setAttribute("disabled", true);
                              o.innerHTML="重新发送(" + wait + ")";
                              wait--;
                              setTimeout(function() {
                                  time(o)
                              },
                              1000)
                          }
                      }
                    document.getElementById("verification_btn").onclick=function(){time(this);}
                  }

                },
                error: function(err) {
                    $("#tip").html('<span class="tip_text">'+data.message+'</span>');
                }     
            });

          }
          if(length > 4){
            //截取前4个字符
            value = value.substring(0,4);
            $("#brokerUserNo").attr("value",value);
          }
        })

        // 验证码请求
   			$("#verification_btn").click(function(){
          var verification = new Object();
          verification.brokerUserNo=$("#brokerUserNo").val();
          var verificationInfo = JSON.stringify(verification);
   				$.ajax({  
   				    type: "post",
   				    url: "/member-server-front/broker/getDynamicPassword",
   				    data:verificationInfo,
   				    dataType: "json",
   				    success: function(data) {
                if(data.status == 0){
                  $("#tip").html('<span class="tip_text">动态密码已发送</span>');
                }else{
                  $("#tip").html('<span class="tip_text">'+data.message+'</span>');
                }
   				    },
   				    error: function(err) {
                  $("#tip").html('<span class="tip_text">'+data.message+'</span>');
   				    }     
   				});
   			})

        // 登录请求
   			$("#login").click(function(){
          var login = new Object();
          login.brokerUserNo=$("#brokerUserNo").val();
          login.DynamicPassword=$("#DynamicPassword").val();
          var loginInfo = JSON.stringify(login);
   				$.ajax({  
   				    type: "post",
   				    url: "/member-server-front/broker/login",
   				    data:loginInfo,
   				    dataType: "json",
   				    success: function(data) {
                var state = data.status;
                if(state == 0){
                  $.cookie('session_token', data.data.session_token,{expires:30});
                  window.location.href="index.html"; 
                }else if(state > 0){
                  $("#tip").html('<span class="tip_text">'+data.message+'</span>');
                  // window.location.href="login.html"; 
                }else if(state < 0){
                  $("#tip").html(data.message);
                  window.location.href="login.html"; 
                }
   				    },
   				    error: function(err) {
   				        $("#tip").html('<span class="tip_text">'+data.message+'</span>');
   				    }     
   				});
   			})
		});
	</script>
</body>
</html>