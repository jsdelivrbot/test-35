<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>已交加盟费</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="css/fcds.css">
	<link rel="stylesheet" href="css/loader.css">
</head>
<body>

	<div class="loader_cover_box">
		<div class="loader">加载中...</div>
	</div>

  <div class="rebate">
      <div class="rebate-header" >
        <span id="tit">高级经纪商</span>
        <span class="right" id="sDete"><!-- 更新日期2017年01月 --></span>
      </div>
      <div class="rebate-list" id="container">
        <div class="oneF">
          <div class="inner">
            <div class="item">最后交款日</div>
            <div class="item">高级级经纪商</div>
            <div class="item">已交总计</div>
          </div>
        </div>
        <ul class="rebate-box width33" id="seniorRebateList">
          <!-- <li>
            <div class="inner">
              <div class="item">
                <p>周一</p>
              </div>
              <div class="item">周大富(第4期)</div>
              <div class="item">100000</div>
            </div>
          </li> -->
        </ul>

      <div class="rebate-header" id="onetit">
        <span><b>一级经纪商</b></span>
        <span>人数总计：<b id="brokerTotal"></b>人</span>
        <span>已交总计：<b id="payAmountTotal"></b></span>
      </div>
      <div class="rebate-list" id="container">
        <div class="oneF">
          <div class="inner">
            <div class="item">最后交款日</div>
            <div class="item">一级经纪商</div>
            <div class="item">已交总计</div>
          </div>
        </div>
        <ul class="rebate-box width33" id="onerebateList">
          <!-- <li>
            <div class="inner">
              <div class="item">
                <p>周一</p>
              </div>
              <div class="item">周大富(第4期)</div>
              <div class="item">100000</div>
            </div>
          </li> -->
        </ul>
        <div class="dropload-down"><div class="dropload-load"><span class="loading"></span>加载中...</div></div>
      </div>
  </div>

  <p class="tips" id="tips">&nbsp;</p>

  <script src="js/jquery-1.8.3.min.js"></script>
  <script src="js/mo.js"></script>
  <script src="js/jquery.cookie.js"></script>
  <!-- <script src="js/common.js"></script> -->
  <script type="text/javascript">
    $(function(){
      $(".loader_cover_box").css("display","block");
      var totalPage = 0;
      var page = 0;
      var session_token = $.cookie('session_token');
      app.ajaxHelper.submitRequest({
          url: '/api/getFranchiseTotalByBroker',
          data: {
              session_token: session_token
          },
          success: function (data) {
              totalPage = data.data.paging.totalPage;
              var state = data.result;
              var emptyHtml = '<div class="empty_data"><div class="empty"></div></div>';

              if (state == "success") {
                $(".loader_cover_box").css("display","none");
                $("#mDete").html('');
                $("#brokerTotal").html(data.data.brokerTotal);
                $("#payAmountTotal").html(data.data.payAmountTotal);
                  function detailedListHtml(payDateMax,brokerUserName,payAmountSum,brokerUserNo) {   
                    var d=new Date(payDateMax); 
                    var html = '<li><div class="inner"><div class="item"><p>'+formatDate(d)+'</p></div><div class="item">'+brokerUserName+'('+brokerUserNo+')</div><div class="item">'+payAmountSum+'</div></div></li>';

                    return html;
                  }
                  $(data.data.oneFranchiseTotalList).each(function(i){
                    var listHtml = detailedListHtml(this.payDateMax,this.brokerUserName,this.payAmountSum,this.brokerUserNo);
                    $('#onerebateList').append(listHtml);
                  })

                  function ListHtml(payDateMax,brokerUserName,payAmountSum,brokerUserNo) {   
                    var d=new Date(payDateMax); 
                    var html = '<li><div class="inner"><div class="item"><p>'+formatDate(d)+'</p></div><div class="item">'+brokerUserName+'('+brokerUserNo+')</div><div class="item">'+payAmountSum+'</div></div></li>';

                    return html;
                  }
                  $(data.data.topBrokerUserFranchise).each(function(i){
                    var listHtml = ListHtml(this.payDateMax,this.brokerUserName,this.payAmountSum,this.brokerUserNo);
                    $('#seniorRebateList').append(listHtml);
                  })

                  if(data.data.rebateList == ''){
                    $("#container").html(emptyHtml)
                  }
              } else if (state > "error") {
                  errors(emptyHtml);
              } else if (state < "noSession") {
                  $("#tip").html('<span class="tip_text">' + data.message + '</span>');
                  window.location.href = "login.html";
              }
          }
      })

        // 分页
      $(window).scroll(function(){
          var wh=$("#container").height();
          var s= wh - $(window).scrollTop() - $(window).height();
          if(s < 0 ){
            page++;
            // alert(totalPage +"---"+page)
            if(totalPage > page){
                $(".dropload-down").css("display","block");
                // var session_token = $.cookie('session_token');
                // var url=decodeURI(location.href);
                // var month=url.split("?")[1];
                var pageIndex = page;
                app.ajaxHelper.submitRequest({
                    url: '/api/getFranchiseTotalByBroker',
                    data: {
                        session_token: session_token,
                        pageIndex: pageIndex
                    },
                    success: function (data) {
                        totalPage = data.data.paging.totalPage;
                        var state = data.result;
                        var emptyHtml = '<div class="empty_data"><div class="empty"></div></div>';
                        if (state == "success") {
                          $(".dropload-down").css("display","none");
                          $("#mDete").html(month);
                            function detailedListHtml(payDateMax,brokerUserName,payAmountSum) {
                              var d=new Date(payDateMax); 
                              var html = '<li><div class="inner"><div class="item"><p>'+formatDate(d)+'</p></div><div class="item">'+brokerUserName+'('+brokerUserNo+')</div><div class="item">'+payAmountSum+'</div></div></li>';

                              return html;
                            }
                            $(data.data.oneFranchiseTotalList).each(function(i){
                              var listHtml = detailedListHtml(this.payDateMax,this.brokerUserName,this.payAmountSum);
                              $('#onerebateList').append(listHtml);
                            })
                            if(data.data.rebateList == ''){
                              $("#container").html(emptyHtml)
                            }
                        } else if (state > "error") {
                            errors(emptyHtml);
                        } else if (state < "noSession") {
                            $("#tip").html('<span class="tip_text">' + data.message + '</span>');
                            window.location.href = "login.html";
                        }
                    }
                })
            }
          }
        });

        $(".loader_cover_box").on('touchmove', function(event) {
          event.preventDefault();
        });

        function formatDate(now) { 
          var year=now.getYear(); 
          var month=now.getMonth()+1; 
          var date=now.getDate(); 
          var hour=now.getHours(); 
          var minute=now.getMinutes(); 
          var second=now.getSeconds(); 
          return month+"-"+date; 
        } 
    });
  </script>
</body>
</html>